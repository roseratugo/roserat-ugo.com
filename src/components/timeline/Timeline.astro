---
import TimelineItem from './TimelineItem.astro';
import { timelineData } from '../../data/timeline';
import { getLangFromUrl } from '../../i18n/utils';

const lang = getLangFromUrl(Astro.url);

const workEntries = timelineData.filter((entry) => entry.type === 'work');
const educationEntries = timelineData.filter((entry) => entry.type === 'education');

const labels = {
  fr: { experience: 'Exp√©rience', education: 'Formation' },
  en: { experience: 'Experience', education: 'Education' },
};
---

<div class="timeline-wrapper">
  <!-- Work Experience -->
  <div class="timeline-section" data-timeline-section>
    <div class="section-header">
      <div class="section-icon" data-magnetic>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="24" height="24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 14.15v4.25c0 1.094-.787 2.036-1.872 2.18-2.087.277-4.216.42-6.378.42s-4.291-.143-6.378-.42c-1.085-.144-1.872-1.086-1.872-2.18v-4.25m16.5 0a2.18 2.18 0 0 0 .75-1.661V8.706c0-1.081-.768-2.015-1.837-2.175a48.114 48.114 0 0 0-3.413-.387m4.5 8.006c-.194.165-.42.295-.673.38A23.978 23.978 0 0 1 12 15.75c-2.648 0-5.195-.429-7.577-1.22a2.016 2.016 0 0 1-.673-.38m0 0A2.18 2.18 0 0 1 3 12.489V8.706c0-1.081.768-2.015 1.837-2.175a48.111 48.111 0 0 1 3.413-.387m7.5 0V5.25A2.25 2.25 0 0 0 13.5 3h-3a2.25 2.25 0 0 0-2.25 2.25v.894m7.5 0a48.667 48.667 0 0 0-7.5 0M12 12.75h.008v.008H12v-.008Z" />
        </svg>
      </div>
      <div class="section-title-wrapper">
        <span class="section-number">01</span>
        <h2 class="section-title" data-text-reveal>{labels[lang].experience}</h2>
      </div>
      <div class="section-line"></div>
    </div>

    <div class="timeline-track">
      <div class="timeline-line">
        <div class="timeline-line-progress" data-timeline-progress></div>
      </div>
      <div class="timeline-items">
        {workEntries.map((entry, index) => (
          <TimelineItem entry={entry} lang={lang} index={index} />
        ))}
      </div>
    </div>
  </div>

  <!-- Education -->
  <div class="timeline-section" data-timeline-section>
    <div class="section-header">
      <div class="section-icon" data-magnetic>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="24" height="24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4.26 10.147a60.438 60.438 0 0 0-.491 6.347A48.62 48.62 0 0 1 12 20.904a48.62 48.62 0 0 1 8.232-4.41 60.46 60.46 0 0 0-.491-6.347m-15.482 0a50.636 50.636 0 0 0-2.658-.813A59.906 59.906 0 0 1 12 3.493a59.903 59.903 0 0 1 10.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.717 50.717 0 0 1 12 13.489a50.702 50.702 0 0 1 7.74-3.342M6.75 15a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm0 0v-3.675A55.378 55.378 0 0 1 12 8.443m-7.007 11.55A5.981 5.981 0 0 0 6.75 15.75v-1.5" />
        </svg>
      </div>
      <div class="section-title-wrapper">
        <span class="section-number">02</span>
        <h2 class="section-title" data-text-reveal>{labels[lang].education}</h2>
      </div>
      <div class="section-line"></div>
    </div>

    <div class="timeline-track">
      <div class="timeline-line">
        <div class="timeline-line-progress" data-timeline-progress></div>
      </div>
      <div class="timeline-items">
        {educationEntries.map((entry, index) => (
          <TimelineItem entry={entry} lang={lang} index={index} />
        ))}
      </div>
    </div>
  </div>
</div>

<style>
  .timeline-wrapper {
    display: flex;
    flex-direction: column;
    gap: 6rem;
  }

  .timeline-section {
    position: relative;
  }

  .section-header {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    margin-bottom: 3rem;
  }

  .section-icon {
    width: 3.5rem;
    height: 3.5rem;
    background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent-dark) 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #ffffff;
    flex-shrink: 0;
    position: relative;
    overflow: hidden;
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .section-icon::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, transparent 0%, rgba(255, 255, 255, 0.2) 100%);
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .section-icon:hover::before {
    opacity: 1;
  }

  .section-title-wrapper {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .section-number {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--color-accent);
    letter-spacing: 0.1em;
  }

  .section-title {
    font-family: var(--font-display);
    font-size: clamp(1.5rem, 4vw, 2rem);
    font-weight: 700;
    color: var(--color-ink);
    overflow: hidden;
  }

  .section-line {
    flex: 1;
    height: 1px;
    background: linear-gradient(90deg, color-mix(in srgb, var(--color-accent) 30%, transparent) 0%, transparent 100%);
  }

  .timeline-track {
    position: relative;
    padding-left: 3rem;
  }

  @media (min-width: 768px) {
    .timeline-track {
      padding-left: 4rem;
    }
  }

  .timeline-line {
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 2px;
    background-color: rgba(0, 0, 0, 0.06);
  }

  .timeline-line-progress {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 0;
    background: linear-gradient(180deg, var(--color-accent) 0%, color-mix(in srgb, var(--color-accent) 30%, transparent) 100%);
    transition: height 0.1s linear;
  }

  .timeline-items {
    display: flex;
    flex-direction: column;
    gap: 0;
  }
</style>

<script>
  import { gsap } from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  gsap.registerPlugin(ScrollTrigger);

  // Timeline progress line animation
  document.querySelectorAll('[data-timeline-section]').forEach((section) => {
    const progressLine = section.querySelector('[data-timeline-progress]');
    const items = section.querySelectorAll('.timeline-item');

    if (progressLine && items.length > 0) {
      ScrollTrigger.create({
        trigger: section,
        start: 'top 60%',
        end: 'bottom 40%',
        onUpdate: (self) => {
          gsap.to(progressLine, {
            height: `${self.progress * 100}%`,
            duration: 0.1,
            ease: 'none',
          });
        },
      });
    }
  });

  // Magnetic effect for icons
  document.querySelectorAll('[data-magnetic]').forEach((el) => {
    const element = el as HTMLElement;

    element.addEventListener('mousemove', (e: MouseEvent) => {
      const rect = element.getBoundingClientRect();
      const x = e.clientX - rect.left - rect.width / 2;
      const y = e.clientY - rect.top - rect.height / 2;

      gsap.to(element, {
        x: x * 0.3,
        y: y * 0.3,
        duration: 0.3,
        ease: 'power2.out',
      });
    });

    element.addEventListener('mouseleave', () => {
      gsap.to(element, {
        x: 0,
        y: 0,
        duration: 0.5,
        ease: 'elastic.out(1, 0.3)',
      });
    });
  });
</script>
